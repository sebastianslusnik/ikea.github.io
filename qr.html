<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="qr.css?v=1.0.15">
</head>
<body>
  <div class="container" align="center">
    <video id="preview" autoplay playsinline></video><br>
    <button id="starter" onclick="start();">START SCANNING</button>
    <button id="stopper" onclick="stop();" style="display: none;">STOP SCANNING</button>
    <span id="result">...</span>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  <script>
    async function checkCameraPermissions() {
      try {
        await navigator.mediaDevices.getUserMedia({video: true});
        return true;
      } catch (err) {
        console.error('Camera access denied:', err);
        return false;
      }
    }

    async function start() {
      if (!(await checkCameraPermissions())) {
        alert('Camera permission denied. Please allow camera access in your browser settings.');
        return;
      }

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        console.log('Available devices:', devices);

        const videoConstraints = {
          video: {
            facingMode: { exact: 'environment' }
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(videoConstraints);

        let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });
        scanner.addListener('scan', function (content) {
          document.getElementById("result").innerHTML = content;
          document.getElementById("preview").style.borderColor = "forestgreen";
        });

        document.getElementById("preview").srcObject = stream;
        scanner.start(stream);

        document.getElementById("starter").style.display = "none";
        document.getElementById("stopper").style.display = "block";

      } catch (e) {
        console.error('Error accessing the camera:', e);
        alert('Unable to access the camera. Please check permissions.');
      }
    }

    function stop() {
      Instascan.Camera.getCameras().then(cameras => {
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });
        scanner.stop().then(() => {
          console.log('Scanner stopped');
          document.getElementById("stopper").style.display = "none";
          document.getElementById("starter").style.display = "block";

          let stream = document.getElementById("preview").srcObject;
          let tracks = stream.getTracks();

          tracks.forEach(function(track) {
            track.stop();
          });

          document.getElementById("preview").srcObject = null;
        }).catch((e) => {
          console.error('Error stopping scanner:', e);
        });
      });
    }
  </script>
</body>
</html>
